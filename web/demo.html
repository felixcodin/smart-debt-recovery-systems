<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Demo - SDRS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-bank2"></i> SDRS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="borrowers.html">
                            <i class="bi bi-people"></i> Borrowers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="recovery.html">
                            <i class="bi bi-graph-up-arrow"></i> Recovery Actions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="demo.html">
                            <i class="bi bi-play-circle"></i> Demo
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1><i class="bi bi-play-circle"></i> Automated Demo Scenario</h1>
                <p class="text-muted">Watch the complete debt recovery workflow in action</p>
            </div>
        </div>

        <!-- Demo Scenario Card -->
        <div class="card fade-in mb-4">
            <div class="card-header">
                <i class="bi bi-file-earmark-text"></i> Demo Scenario
            </div>
            <div class="card-body">
                <h5>Complete Debt Recovery User Story</h5>
                <p>This demo will execute the following 8-step workflow:</p>
                <ol>
                    <li><strong>Borrower Registration</strong> - Create a new borrower in the system</li>
                    <li><strong>Verify in Database</strong> - Confirm borrower data persistence</li>
                    <li><strong>Loan Account Status</strong> - Simulate overdue payment scenario</li>
                    <li><strong>Credit Risk Assessment</strong> - Evaluate default probability</li>
                    <li><strong>Available Strategies</strong> - List recovery options</li>
                    <li><strong>Execute Strategy</strong> - Apply automated reminder approach</li>
                    <li><strong>Send Communications</strong> - Deliver email and SMS notifications</li>
                    <li><strong>Communication History</strong> - Track all interactions</li>
                </ol>
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-lg" onclick="startDemo()" id="startBtn">
                        <i class="bi bi-play-fill"></i> Start Demo
                    </button>
                    <button class="btn btn-secondary btn-lg ms-2" onclick="stopDemo()" id="stopBtn" disabled>
                        <i class="bi bi-stop-fill"></i> Stop Demo
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="card fade-in mb-4" id="progressCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-hourglass-split"></i> Demo Progress
            </div>
            <div class="card-body">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                        id="progressBar" role="progressbar" style="width: 0%">
                        0%
                    </div>
                </div>
                <p class="mt-3 text-center" id="currentStep"></p>
            </div>
        </div>

        <!-- Console Output -->
        <div class="card fade-in">
            <div class="card-header">
                <i class="bi bi-terminal"></i> Console Output
            </div>
            <div class="card-body">
                <div class="demo-console" id="console">
                    <div class="log-entry log-info">
                        >>> Ready to start demo. Click "Start Demo" button above.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    
    <script>
        let demoRunning = false;
        let borrowerId = null;

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function updateProgress(step, total) {
            const percentage = (step / total) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
        }

        function setCurrentStep(stepText) {
            document.getElementById('currentStep').textContent = stepText;
        }

        async function startDemo() {
            demoRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('progressCard').style.display = 'block';
            document.getElementById('console').innerHTML = '';
            
            log('='.repeat(60), 'info');
            log('SMART DEBT RECOVERY SYSTEM - AUTOMATED DEMO', 'info');
            log('='.repeat(60), 'info');
            log('', 'info');
            
            try {
                // Step 1: Register Borrower
                if (!demoRunning) return;
                updateProgress(1, 8);
                setCurrentStep('Step 1/8: Registering new borrower...');
                log('STEP 1: Borrower Registration', 'info');
                
                const borrowerData = {
                    name: "Demo User " + Date.now(),
                    email: "demo" + Date.now() + "@example.com",
                    phone_number: "090" + Math.floor(Math.random() * 10000000),
                    date_of_birth: "1990-01-15",
                    employment_status: "Employed",
                    monthly_income: 20000000,
                    address: "123 Demo Street, Hanoi, Vietnam"
                };
                
                const createResponse = await api.createBorrower(borrowerData);
                borrowerId = createResponse.data.borrower_id;
                log(`✓ Borrower created successfully (ID: ${borrowerId})`, 'success');
                await sleep(1000);
                
                // Step 2: Verify Borrower
                if (!demoRunning) return;
                updateProgress(2, 8);
                setCurrentStep('Step 2/8: Verifying borrower in database...');
                log('STEP 2: Verify Borrower in Database', 'info');
                
                const verifyResponse = await api.getBorrower(borrowerId);
                log(`✓ Borrower verified: ${verifyResponse.data.first_name} ${verifyResponse.data.last_name}`, 'success');
                await sleep(1000);
                
                // Step 3: Loan Account Status
                if (!demoRunning) return;
                updateProgress(3, 8);
                setCurrentStep('Step 3/8: Simulating overdue loan account...');
                log('STEP 3: Loan Account Status', 'info');
                log('  Loan Account ID: 200', 'info');
                log('  Outstanding Amount: 5,000,000 VND', 'warning');
                log('  Days Overdue: 15', 'warning');
                log('✓ Overdue account scenario prepared', 'success');
                await sleep(1500);
                
                // Step 4: Risk Assessment
                if (!demoRunning) return;
                updateProgress(4, 8);
                setCurrentStep('Step 4/8: Assessing credit risk...');
                log('STEP 4: Credit Risk Assessment', 'info');
                
                const riskData = {
                    borrower_id: borrowerId,
                    account_id: 200,
                    days_past_due: 15,
                    missed_payments: 1,
                    loan_amount: 50000000,
                    remaining_amount: 5000000,
                    interest_rate: 0.125,
                    monthly_income: 20000000,
                    account_age_months: 6
                };
                
                const riskResponse = await api.assessRisk(riskData);
                log(`✓ Risk Score: ${(riskResponse.data.risk_score * 100).toFixed(0)}`, 'warning');
                log(`✓ Risk Level: ${riskResponse.data.risk_level}`, 'warning');
                await sleep(1500);
                
                // Step 5: Available Strategies
                if (!demoRunning) return;
                updateProgress(5, 8);
                setCurrentStep('Step 5/8: Fetching available strategies...');
                log('STEP 5: Available Recovery Strategies', 'info');
                
                const strategiesResponse = await api.getStrategies();
                log(`✓ Found ${strategiesResponse.data.strategies.length} strategies`, 'success');
                strategiesResponse.data.strategies.forEach(s => {
                    log(`  - ${s.name} (${s.risk_level})`, 'info');
                });
                await sleep(1500);
                
                // Step 6: Execute Strategy
                if (!demoRunning) return;
                updateProgress(6, 8);
                setCurrentStep('Step 6/8: Executing recovery strategy...');
                log('STEP 6: Execute Recovery Strategy', 'info');
                
                const strategyData = {
                    strategy_type: "automated_reminder",
                    account_id: 200,
                    borrower_id: borrowerId
                };
                
                const strategyResponse = await api.executeStrategy(strategyData);
                log(`✓ Strategy "${strategyData.strategy_type}" executed`, 'success');
                log(`  Status: ${strategyResponse.data.status}`, 'success');
                await sleep(1500);
                
                // Step 7: Send Communications
                if (!demoRunning) return;
                updateProgress(7, 8);
                setCurrentStep('Step 7/8: Sending notifications...');
                log('STEP 7: Send Automated Communications', 'info');
                
                // Send Email
                const emailData = {
                    to: borrowerData.email,
                    subject: "Payment Reminder - Loan Account #200",
                    body: "Your payment of 5,000,000 VND is overdue by 15 days."
                };
                await api.sendEmail(emailData);
                log('✓ Email sent successfully', 'success');
                await sleep(500);
                
                // Send SMS
                const smsData = {
                    phone: borrowerData.phone_number,
                    message: "SDRS: Payment overdue by 15 days. Please contact us."
                };
                await api.sendSMS(smsData);
                log('✓ SMS sent successfully', 'success');
                await sleep(1500);
                
                // Step 8: Communication History
                if (!demoRunning) return;
                updateProgress(8, 8);
                setCurrentStep('Step 8/8: Retrieving communication history...');
                log('STEP 8: Communication History', 'info');
                
                const historyResponse = await api.getCommunicationHistory(borrowerId);
                log(`✓ Retrieved ${historyResponse.data.communications.length} communications`, 'success');
                await sleep(1000);
                
                // Demo Complete
                log('', 'info');
                log('='.repeat(60), 'success');
                log('DEMO COMPLETED SUCCESSFULLY!', 'success');
                log('='.repeat(60), 'success');
                log('', 'info');
                log('Summary:', 'info');
                log(`  ✓ Borrower ID: ${borrowerId}`, 'success');
                log(`  ✓ Risk Score: ${(riskResponse.data.risk_score * 100).toFixed(0)}`, 'success');
                log(`  ✓ Strategy: Automated Reminder`, 'success');
                log(`  ✓ Communications Sent: 2`, 'success');
                log('', 'info');
                log('All microservices worked together successfully!', 'success');
                
            } catch (error) {
                log('', 'error');
                log('ERROR: Demo failed!', 'error');
                log(`Message: ${error.message}`, 'error');
                log('', 'error');
            } finally {
                demoRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        function stopDemo() {
            demoRunning = false;
            log('', 'warning');
            log('Demo stopped by user', 'warning');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
