<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borrower Management - SDRS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-bank2"></i> SDRS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="borrowers.html">
                            <i class="bi bi-people"></i> Borrowers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="recovery.html">
                            <i class="bi bi-graph-up-arrow"></i> Recovery Actions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="demo.html">
                            <i class="bi bi-play-circle"></i> Demo
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <h1><i class="bi bi-people"></i> Borrower Management</h1>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success me-2" onclick="segmentBorrowers()">
                    <i class="bi bi-diagram-3"></i> Segment Borrowers (K-Means)
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBorrowerModal">
                    <i class="bi bi-plus-circle"></i> Add New Borrower
                </button>
            </div>
        </div>

        <!-- Borrowers Table -->
        <div class="card fade-in">
            <div class="card-header">
                <i class="bi bi-table"></i> All Borrowers
            </div>
            <div class="card-body">
                <div id="borrowersTable"></div>
            </div>
        </div>
    </div>

    <!-- Add Borrower Modal -->
    <div class="modal fade" id="addBorrowerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Add New Borrower
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBorrowerForm">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="name" required 
                                    placeholder="e.g., Nguyen Van A">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" required
                                    placeholder="email@example.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" id="phone_number" required
                                    placeholder="0901234567">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="date_of_birth"
                                    value="1985-01-01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Employment Status</label>
                                <select class="form-control" id="employment_status">
                                    <option value="Employed">Employed</option>
                                    <option value="Self-Employed">Self-Employed</option>
                                    <option value="Unemployed">Unemployed</option>
                                    <option value="Retired">Retired</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Monthly Income (VND)</label>
                                <input type="number" class="form-control" id="monthly_income"
                                    placeholder="15000000" value="15000000">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Address *</label>
                                <textarea class="form-control" id="address" rows="2" required
                                    placeholder="Street, District, City"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitBorrower()">
                        <i class="bi bi-check-circle"></i> Create Borrower
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Borrower Details Modal -->
    <div class="modal fade" id="borrowerDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-badge"></i> Borrower Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="borrowerDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content" type="button">
                                <i class="bi bi-person-circle"></i> Information
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment-content" type="button" onclick="loadPaymentHistory()">
                                <i class="bi bi-credit-card"></i> Payment History
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content" id="borrowerDetailsContent">
                        <div class="tab-pane fade show active" id="info-content" role="tabpanel">
                            <!-- Borrower info loaded dynamically -->
                        </div>
                        <div class="tab-pane fade" id="payment-content" role="tabpanel">
                            <div id="paymentHistoryContent">
                                <div class="spinner-container">
                                    <div class="spinner-border text-primary"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    
    <script>
        let borrowersModal;
        let detailsModal;
        let currentBorrowerId = null;  // Track current borrower for payment history

        async function loadBorrowers() {
            showLoading('borrowersTable');
            
            try {
                const response = await api.getBorrowers();
                const borrowers = response.data;
                
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Income</th>
                                    <th>Account Age</th>
                                    <th>Risk Segment</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                borrowers.forEach(borrower => {
                    const segmentBadge = borrower.risk_segment === 'Low' ? 'bg-success' :
                                        borrower.risk_segment === 'Medium' ? 'bg-warning' :
                                        borrower.risk_segment === 'High' ? 'bg-danger' : 'bg-secondary';
                    
                    const accountAgeMonths = borrower.account_age_months || 0;
                    const accountAgeDisplay = accountAgeMonths < 12 ? 
                        `${accountAgeMonths} ${accountAgeMonths === 1 ? 'month' : 'months'}` : 
                        `${Math.floor(accountAgeMonths / 12)} ${Math.floor(accountAgeMonths / 12) === 1 ? 'year' : 'years'}`;
                    
                    html += `
                        <tr onclick="showBorrowerDetails(${borrower.borrower_id})">
                            <td>${borrower.borrower_id}</td>
                            <td>${borrower.first_name} ${borrower.last_name}</td>
                            <td>${borrower.email}</td>
                            <td>${borrower.phone_number}</td>
                            <td>${formatCurrency(borrower.monthly_income)}</td>
                            <td><small class="text-muted">${accountAgeDisplay}</small></td>
                            <td>
                                <span class="badge ${segmentBadge}">
                                    ${borrower.risk_segment || 'Unclassified'}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${borrower.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${borrower.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); showBorrowerDetails(${borrower.borrower_id})">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('borrowersTable').innerHTML = html;
                
            } catch (error) {
                console.error('Failed to load borrowers:', error);
                document.getElementById('borrowersTable').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Failed to load borrowers. Please ensure the borrower service is running.
                    </div>
                `;
            }
        }

        async function submitBorrower() {
            const borrowerData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone_number: document.getElementById('phone_number').value,
                date_of_birth: document.getElementById('date_of_birth').value,
                employment_status: document.getElementById('employment_status').value,
                monthly_income: parseFloat(document.getElementById('monthly_income').value),
                address: document.getElementById('address').value
            };
            
            try {
                await api.createBorrower(borrowerData);
                showAlert('Borrower created successfully!', 'success');
                borrowersModal.hide();
                document.getElementById('addBorrowerForm').reset();
                loadBorrowers();
            } catch (error) {
                console.error('Failed to create borrower:', error);
                showAlert('Failed to create borrower: ' + error.message, 'danger');
            }
        }

        async function showBorrowerDetails(borrowerId) {
            try {
                currentBorrowerId = borrowerId;  // Store for payment history tab
                
                const response = await api.getBorrower(borrowerId);
                const borrower = response.data;
                
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ID:</strong> ${borrower.borrower_id}</p>
                            <p><strong>Name:</strong> ${borrower.first_name} ${borrower.last_name}</p>
                            <p><strong>Email:</strong> ${borrower.email}</p>
                            <p><strong>Phone:</strong> ${borrower.phone_number}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Date of Birth:</strong> ${borrower.date_of_birth}</p>
                            <p><strong>Age:</strong> ${borrower.age}</p>
                            <p><strong>Account Age:</strong> ${borrower.account_age_months || 0} months</p>
                            <p><strong>Employment:</strong> ${borrower.employment_status}</p>
                            <p><strong>Monthly Income:</strong> ${formatCurrency(borrower.monthly_income)}</p>
                            <p><strong>Risk Segment:</strong> 
                                <span class="badge ${borrower.risk_segment === 'Low' ? 'bg-success' : borrower.risk_segment === 'Medium' ? 'bg-warning' : borrower.risk_segment === 'High' ? 'bg-danger' : 'bg-secondary'}">
                                    ${borrower.risk_segment || 'Unclassified'}
                                </span>
                            </p>
                            <p><strong>Status:</strong> 
                                <span class="badge ${borrower.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${borrower.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </p>
                        </div>
                        <div class="col-12 mt-3">
                            <p><strong>Address:</strong> ${borrower.address}</p>
                            <p class="text-muted">
                                <small>Created: ${formatDate(borrower.created_at)}</small><br>
                                <small>Updated: ${formatDate(borrower.updated_at)}</small>
                            </p>
                        </div>
                    </div>
                `;
                
                document.getElementById('info-content').innerHTML = content;
                detailsModal.show();
                
            } catch (error) {
                console.error('Failed to load borrower details:', error);
                showAlert('Failed to load borrower details', 'danger');
            }
        }
        
        // Load payment history for current borrower
        async function loadPaymentHistory() {
            if (!currentBorrowerId) {
                document.getElementById('paymentHistoryContent').innerHTML = '<p class="text-muted">No borrower selected</p>';
                return;
            }
            
            try {
                document.getElementById('paymentHistoryContent').innerHTML = `
                    <div class="spinner-container">
                        <div class="spinner-border text-primary"></div>
                    </div>
                `;
                
                const response = await api.getPaymentHistory(currentBorrowerId);
                const payments = response.data;
                
                if (payments.length === 0) {
                    document.getElementById('paymentHistoryContent').innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No payment history found for this borrower.
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Payment ID</th>
                                    <th>Account ID</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Late</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                payments.forEach(payment => {
                    const statusBadge = payment.status === 'Completed' ? 'bg-success' :
                                       payment.status === 'Pending' ? 'bg-warning' :
                                       payment.status === 'Failed' ? 'bg-danger' : 'bg-secondary';
                    
                    html += `
                        <tr>
                            <td>${payment.payment_id}</td>
                            <td>${payment.account_id}</td>
                            <td>${formatDate(payment.payment_date)}</td>
                            <td>${formatCurrency(payment.payment_amount)}</td>
                            <td>${payment.payment_method}</td>
                            <td><span class="badge ${statusBadge}">${payment.status}</span></td>
                            <td>${payment.is_late ? '<span class="badge bg-danger">Late</span>' : '<span class="badge bg-success">On Time</span>'}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">Total payments: ${payments.length}</small>
                    </div>
                `;
                
                document.getElementById('paymentHistoryContent').innerHTML = html;
                
            } catch (error) {
                console.error('Failed to load payment history:', error);
                document.getElementById('paymentHistoryContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Failed to load payment history: ${error.message}
                    </div>
                `;
            }
        }
        
        // K-Means Clustering - Segment borrowers into Low/Medium/High risk groups
        async function segmentBorrowers() {
            try {
                showAlert('Running K-Means clustering... Please wait', 'info');
                
                // Fetch all borrowers
                const response = await api.getBorrowers();
                const borrowers = response.data;
                
                if (borrowers.length < 3) {
                    showAlert('Need at least 3 borrowers to perform clustering', 'warning');
                    return;
                }
                
                // Extract features for clustering
                const features = borrowers.map(b => {
                    // Get total loan amount for debt ratio calculation
                    const totalLoan = 100000000; // Mock value, would normally fetch from loans
                    const debtRatio = b.monthly_income > 0 ? totalLoan / (b.monthly_income * 12) : 1.0;
                    
                    return {
                        age: b.age || 30,
                        monthly_income: b.monthly_income || 10000000,
                        debt_ratio: debtRatio,
                        days_past_due: 0,  // Mock value
                        missed_payments: 0  // Mock value
                    };
                });
                
                // Call K-Means clustering API
                const clusterResult = await api.clusterBorrowers({
                    num_clusters: 3,
                    features: features
                });
                
                const labels = clusterResult.data.labels;
                const centroids = clusterResult.data.centroids;
                
                // Determine which cluster is Low/Medium/High based on centroids
                // Lower debt_ratio + lower days_past_due = Low risk
                const centroidScores = centroids.map((c, idx) => ({
                    idx: idx,
                    score: c.debt_ratio * 0.5 + c.days_past_due * 0.3 + c.missed_payments * 0.2
                }));
                centroidScores.sort((a, b) => a.score - b.score);
                
                const clusterMapping = {
                    [centroidScores[0].idx]: 'Low',
                    [centroidScores[1].idx]: 'Medium',
                    [centroidScores[2].idx]: 'High'
                };
                
                // Update each borrower with their segment via API
                showAlert(`Updating ${borrowers.length} borrowers with their risk segments...`, 'info');
                
                let updateCount = 0;
                const updatePromises = borrowers.map(async (borrower, i) => {
                    const segment = clusterMapping[labels[i]];
                    try {
                        await api.updateBorrowerSegment(borrower.borrower_id, segment);
                        updateCount++;
                        console.log(`âœ“ Borrower ${borrower.borrower_id} (${borrower.full_name}): ${segment}`);
                        return { id: borrower.borrower_id, name: borrower.full_name, segment, success: true };
                    } catch (error) {
                        console.error(`âœ— Failed to update borrower ${borrower.borrower_id}:`, error);
                        return { id: borrower.borrower_id, name: borrower.full_name, segment, success: false, error };
                    }
                });
                
                const results = await Promise.all(updatePromises);
                
                // Count segments
                const segmentCounts = { Low: 0, Medium: 0, High: 0 };
                results.forEach(r => { if (r.success) segmentCounts[r.segment]++; });
                
                // Show results summary
                const summary = `
                    <strong>K-Means Clustering Complete!</strong><br>
                    Successfully segmented ${updateCount} of ${borrowers.length} borrowers:<br>
                    ðŸŸ¢ Low Risk: ${segmentCounts.Low}<br>
                    ðŸŸ¡ Medium Risk: ${segmentCounts.Medium}<br>
                    ðŸ”´ High Risk: ${segmentCounts.High}<br>
                    <small>Check console for detailed results</small>
                `;
                
                showAlert(summary, 'success');
                
                // Log detailed results
                console.log('=== K-Means Clustering Results ===');
                console.log('Centroids:', centroids);
                console.log('Cluster Mapping:', clusterMapping);
                console.log('Detailed Results:', results);
                
                // Refresh table to show new segments
                setTimeout(() => {
                    loadBorrowers();
                }, 2000);
                
            } catch (error) {
                console.error('Clustering failed:', error);
                showAlert('Failed to segment borrowers: ' + error.message, 'danger');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            borrowersModal = new bootstrap.Modal(document.getElementById('addBorrowerModal'));
            detailsModal = new bootstrap.Modal(document.getElementById('borrowerDetailsModal'));
            loadBorrowers();
        });
    </script>
</body>
</html>
